{% extends 'navbar.html' %}
<style>
    .main_body {
        display: flex;
        justify-content: center;
        padding-top: 5px;
        padding-left: 150px;
        background-color: #f7f7f7;
    }
</style>
<head>
</head>
<!DOCTYPE html>
<html>
<head>
    <title>노래 차트</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
</head>


{% block content %}
<body>
    <h1><a href="/">Home</a></h1>
    <h2><a href="/song-list/">노래 리스트</a></h2>
    <table>
        <thead>
            <tr>
                <th colspan="6">
                    <div style="text-align: center;">
                        <form method="post">
                            {% csrf_token %}
                            <button>
                                <a href="http://127.0.0.1:8000/song-list/">TJ</a>
                            </button>
                            <button>
                                <a href="http://127.0.0.1:8000/song-list/ky/">KY</a>
                            </button>
                        </form>
                    </div>
                </th>
            </tr>
            <tr>
                <th>순위</th>
                <th>곡번호</th>
                <th>곡명</th>
                <th>아티스트</th>
                <th>작곡가</th>
                <th>작사가</th>
                <th>Mylist</th>
            </tr>
        </thead>
        <tbody>
            {% for song in songs %}
            <tr>
                <td>{{ song.rank }}</td>
                <td>{{ song.song_num_id }}</td>
                <td>{{ song.title }}</td>
                <td>{{ song.artist }}</td>
                <td>{{ song.cmp }}</td>
                <td>{{ song.writer }}</td>
                <td>
                    <button onclick="addToDB('{{ song.song_num_id }}', selectedCategory)">추가</button>
                    <select id="folderSelect">
                        {% for folder in folders %}
                            <option value="{{ folder.list_number }}">{{ folder.list_name }}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
{% endblock %}


{% block script %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>    
    function addToDB(song_num_id) {
        // 선택한 My_folder의 list_number와 list_name 가져오기
        var folderSelect = document.getElementById("folderSelect");
        var listNumber = folderSelect.value;
        var listName = folderSelect.options[folderSelect.selectedIndex].text;


        console.log(song_num_id);

        // AJAX 요청을 생성
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/song-list/add-to-tjlist/', true);

        // 서버 응답 처리
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log('데이터 추가 성공');
            }
        };

        // 요청 헤더에 CSRF 토큰을 추가
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
        xhr.setRequestHeader("Content-Type", "application/json");

        //데이터 전송
        var data = {
            song_num_id: song_num_id,
            listNumber: listNumber,
            listName: listName
        };
        xhr.send(JSON.stringify(data));

        console.log(data)
    }

    

    $(document).ready(function() {
        $("button").click(function() {
            var category = $(this).val();  // 버튼의 값(category)을 가져옴
            var query = $("input[name='query']").val();  // 검색어를 가져옴
            var folderSelect = $("#folderSelect");


            $.ajax({
                type: 'POST',
                url: '/song-list/',
                data: {
                    'category': category,
                    'query': query,  // 검색어(query)를 데이터에 포함시킴
                },
                success: function(response) {
                    // 필터링된 노래 리스트를 받아와서 화면에 표시하는 로직 작성
                    console.log(response);
                }
            });
        });
    });

    $.ajaxSetup({
        headers: { "X-CSRFToken": csrftoken }
    });

    

</script>

{% endblock %}