{% extends 'navbar.html' %}
{% block style %}


<!-- jquery 사용하기 위해 -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/95c5c08857.js" crossorigin="anonymous"></script>

<style>
    li, ol, ul{
        list-style: none;
    }

    .modal {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(1.5px);
        -webkit-backdrop-filter: blur(1.5px);
    }

    .modal_window {
        background: white;
        backdrop-filter: blur(13.5px);
        -webkit-backdrop-filter: blur(13.5px);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        width: 300px;
        height: 200px;
        position: relative;
    }

    .modal_title{
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        font-weight: bold;
        font-size: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.18);
    }

    .modal_title_side{
        margin: 5px;
        flex: 0 0 40px;
        text-align: center;
    }

    .modal_content_write{
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(0, 0, 0, 0.18);;
    }

    .feed_content_textarea{
        resize: none;
        width: 294px;
        border: none;
    }

    /* 기본 스타일 */
    .dashboard_container,
    .list_container {
        max-width: 700px;
        width: 100%;
        margin: 0 auto;
    }

    .list_container {
        flex-wrap: wrap;
        background-color: white;
        display: flex;
    }

    .list_item {
        background-color: aliceblue;
        width: 150px;
        max-width: 150px;
        margin: 10px;
        display: flex;
    }

    .list_name {
        position: relative;
        z-index: 10;
        padding-top: 0px;
        padding-left: auto;
        width: 170px;
        text-align: center;
    }

    @media screen and (max-width: 767px) {
    /* 브라우저가 767px 이하일 때 적용되는 스타일 */
    .dashboard_container,
    .list_container {
            padding-left: 20px;
            padding-right: 20px;
            display: flex;
            margin: 20px auto; 
        }
    }

    @media screen and (max-width: 480px) {
    /* 브라우저가 480px 이하일 때 적용되는 스타일 */
    .dashboard_container,
    .list_container {
        padding-left: 10px;
        padding-right: 10px;
        background-color: white;
        display: flex;
        margin: 0 auto; 
        justify-content: space-evenly;
    }

    .list_item {
        flex-basis: 100%;
    }}


    .list_button {
        background-image: url("/static/img/music-book.png");
        background-size: cover; /* 이미지를 버튼에 맞게 조절합니다. */
        background-position: center; /* 이미지를 가운데로 정렬합니다. */
    }

    .button-add-list {
        background-image: url("/static/img/add-button.png");
        background-size: cover; /* 이미지를 버튼에 맞게 조절합니다. */
        background-position: center; /* 이미지를 가운데로 정렬합니다. */
    }
   
    .logo-box {
        display: flex;
        width: 108px; 
        height: 39px; 
        background: white; 
        border-radius: 15px;
        justify-content: space-around;
        position: relative;
        margin: 0 auto;
    }

    .logo-text {
        display: flex;
        text-align: center; 
        color: black; 
        font-size: 12px; 
        font-family: Inter; 
        font-weight: 500; 
        word-wrap: break-word;
        align-items: center;
    }

    .main-box {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 17px;
        padding-top: 18px;
        padding-left: 10px;
        padding-right: 10px;
        margin: 0 auto;
        position: relative;
        width: 100%;
    }

    .searchbar {
        display: flex;
        width:80%;
        height: 39px;
        flex-shrink: 0;
        border-radius: 20px;
        background: var(--ui-white, #FFF);
        position: relative;
        align-items: center;
    }

    .search-img {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        position: relative;
        padding-left: 15px;
    }

    .search-text {
        text-align: center;
        color: #B0B0B1;
        font-size: 12px;
        font-family: Inter;
        font-weight: 300;
        word-wrap: break-word;
        padding-left: 33px;
    }

    .main-banner {
        width: 100%;
        height: 137px;
        position: relative;
    }

    .dashboard {
        width: 100%; 
        height: 137px; 
        background: #45D3B1; 
        border-radius: 20px;
        left: 0px;
        top: 0px;
        position:absolute;
    }

    .banner-profile {
        width: 100%;
        height: 95px;
        left: 24px;
        top: 21px;
        position: absolute;
    }
    
    .profile-img-box {
        width: 95px; 
        height: 95px; 
        left: 0px; 
        top: 0px; 
        position: absolute
    }

    .profile-img {
        width: 95px; 
        height: 95px; 
        left: 0px; 
        top: 0px; 
        position: absolute; 
        background: #F6F7FD;
        border-radius: 50%;
    }

    .Dicons {
        width: 56px;
        height: 72px;
        left: 20px;
        top: 12px;
        position: absolute;
        flex-direction: column; 
        justify-content: center; 
        align-items: center; 
        display: inline-flex;
    }

    .frame-25 {
        display: flex;
        flex-direction: row;
        gap: 5px;
        align-items: center;
        justify-content: flex-start;
        position: relative;
        padding-left: 134px;
        padding-top: 20px;
    }

    .frame-25-text-1 {
        color: #ffffff;
        text-align: center;
        font: 400 20px "Noto Sans", sans-serif;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .frame-25-text-2 {
        color: #4c5057;
        text-align: left;
        font: 500 12px "Noto Sans", sans-serif;
        position: relative;
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
    }

    .frame-1992 {
        display: flex;
        flex-direction: row;
        gap: 5px;
        align-items: center;
        justify-content: flex-start;
        position: relative;
        padding-left: 134px;
    }

    .group-25 {
        flex-shrink: 0;
        width: 190px;
        height: 44px;
        position: static;
        display: flex;
    }

    .frame-1992-text-1 {
        color: var(--sub, #37385e);
        text-align: center;
        font: 400 15px "Noto Sans", sans-serif;
        position: relative;
        left: 0px;
        top: 14px;
        width: 90px;
        display: flex;
        justify-content: flex-start;
    }

    .frame-1992-text-2 {
        color: var(--main, #1e1f4b);
        text-align: center;
        font: 400 32px "Noto Sans", sans-serif;
        position: relative;
        left: 0px;
        top: 0px;
        width: 49px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
    }

    .frame-1992-text-3 {
        color: var(--sub, #37385e);
        text-align: center;
        font: 400 15px "Noto Sans", sans-serif;
        position: relative;
        left: 0px;
        top: 14px;
        width: 14px;
        display: flex;
        justify-content: flex-start;
    }

    .vector {
        flex-shrink: 0;
        position: relative;
        overflow: visible;
    }

    .recommend-banner,
    .recommend-banner * {
        box-sizing: border-box;
    }

    .recommend-banner {
        width: 100%;
        height: 60px;
        position: relative;
        background: var(--ui-white, #ffffff);
        border-radius: 20px;
    }

    .recommend-banner-design {
        background: var(--ui-white, #ffffff);
        border-radius: 20px;
        width: 100%;
        height: 60px;
        position: absolute;
        left: 0px;
        top: 0px;
    }

    .recommend-title {
        border-radius: 30px;
        padding: 0px 15px 0px 15px;
        display: flex;
        flex-direction: row;
        gap: 134px;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        position: absolute;
        left: 11px;
        top: 13px;
    }

    .ai {
        color: #000000;
        text-align: left;
        font: var(--bold-15-pt, 400 15px "Noto Sans", sans-serif);
        position: relative;
    }

    .frame-4 {
        padding: 10px;
        display: flex;
        flex-direction: row;
        gap: 10px;
        align-items: flex-start;
        justify-content: flex-start;
        flex-shrink: 0;
        position: relative;
        overflow: visible;
    }

    .folder-box,
    .folder-box * {
        box-sizing: border-box;
    }
    .folder-box {
        flex-shrink: 0;
        width: 100%;
        height: auto;
        position: relative;
        display: flex;
        justify-content: space-around;
    }

    .folder-box-design {
        background: var(--ui-white, #ffffff);
        border-radius: 20px;
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0px;
        top: 0px;
    }

    .folder-box-title {
        padding: 0px 15px 0px 15px;
        display: flex;
        flex-direction: row;
        gap: 203px;
        align-items: flex-end;
        justify-content: flex-start;
        width: 100%;
        position: absolute;
        left: 11px;
        top: 14px;
    }

    .folder-box-title-text {
        color: #000000;
        text-align: left;
        font: var(--bold-15-pt, 400 15px "Noto Sans", sans-serif);
        position: relative;
    }

    .folder {
        flex-shrink: 0;
        width: 155px;
        height: 140px;
        display: flex;
        background: #45d3b1;
        border-radius: 20px;
        margin: 5px;
    }

    .folder-design {
        background: #45d3b1;
        border-radius: 20px;
        width: 136px;
        height: 135.77px;
        left: 0px;
        top: 0px;
    }

    .group-24 {
        width: 136px;
        height: 161px;
        left: 0px;
        top: 0px;
    }
    
    .folder-name-1 {
        color: #ffffff;
        text-align: left;
        font: 700 15px "Noto Sans KR", sans-serif;
        left: 19.26px;
        top: 8.41px;
        width: 89.06px;
        height: 45.66px;
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
        padding-left: 15px;
    }

    .folder-name-2 {
        color: #8d94a0;
        text-align: left;
        font: 700 15px "Noto Sans KR", sans-serif;
        left: 19.26px;
        top: 8.41px;
        width: 110px;
        height: 45.66px;
        display: flex;
        align-items: flex-end;
        justify-content: flex-start;
        padding-left: 15px;
    }

    .folder-in-song {
        color: #ffffff;
        text-align: left;
        font: 500 12px "Noto Sans KR", sans-serif;
        /* position: absolute; */
        width: auto;
        height: 45.66px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding-top: 60px;
        padding-left: 15px;
    }

    .ellipse-11,
    .ellipse-11 * {
        box-sizing: border-box;
    }
    .ellipse-11 {
        background: var(--sub, #37385e);
        border-radius: 50%;
        width: 37.31px;
        height: 37.25px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-around;
        
    }
    ._3-dicons,
    ._3-dicons * {
        box-sizing: border-box;
    }
    ._3-dicons {
        width: 22.87px;
        height: 20.32px;
        position: relative;
    }
    ._3-dicons2 {
        width: 22.87px;
        height: 20.32px;
        position: absolute;
        left: 0px;
        top: 0px;
    }

</style>
{% endblock %}


{% block content %}
<div class="home">
    <div class="main">
        <div class="logo-box">
            <div class="logo-text">
                알송달송<br/>로고
            </div>
        </div>

        <div class="main-box">
            <div class="searchbar">
                <div class="search-img">
                    <img src="/static/img/icon-search-normal-1.svg">
                </div>
                <div class="search-text">
                    부르고 싶은 곡을 검색하세요!
                </div>
            </div>
            
            <div class="main-banner">
                <div class="dashboard"></div>
                <div class="banner-profile">

                    <div class="profile-img-box">
                        <div class="profile-img">
                            <div class="Dicons">
                                <img style="width: 56px; height: 72px" src="/static/img/music.svg" />
                            </div>
                        </div>
                    </div>
                    {% for users in user %}
                    <div class="frame-25">
                        <div class="frame-25-text-1">{{users.nickname}}</div>
                        <div class="frame-25-text-2">님 안녕하세요 🎶</div>
                    </div>
                    {% endfor %}
                    <div class="frame-1992">
                        <div class="group-25">
                            <div class="frame-1992-text-1">총 달린 곡</div>
                            {% with total_song_count=0 %}
                                {% for list in folder_list %}
                                    {% with new_total_song_count=total_song_count|add:list.song_count %}
                                        {% with total_song_count=new_total_song_count %}
                                        {% endwith %}
                                    {% endwith %}
                                {% endfor %}
                                <div class="frame-1992-text-2">{{ total_song_count }}</div>
                            {% endwith %}
                            <div class="frame-1992-text-3">곡</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="recommend-banner">
                <div class="recommend-title">
                    <div class="ai">Ai 부를곡 추천 받기!</div>
                    <img class="frame-4" src="/static/img/vector.svg">
                </div>
            </div>

            <div class="folder-box">
                <div class="folder-box-design"></div>
                <div class="folder-box-title">
                    <div class="folder-box-title-text">달송 폴더</div>
                </div>

                <div class="folder-box" style="margin-top: 50px; margin-bottom: 20px; justify-content: space-around; flex-direction: row; flex-wrap: wrap; width: calc(2*168px + 2*1vw);">
                    {% for list in folder_list %}
                    <div class="folder list_button" data-list-number="{{ list.list_number }}">
                        <div>
                            <div class="folder-name-1">{{list.list_name}}</div>
                            <div class="folder-in-song">{{list.song_count}} 곡</div>
                        </div>
                        <div style="padding-top: 80px; padding-left: 20px;">
                            <div class="ellipse-11">
                                <div class="_3-dicons">
                                    <img class="_3-dicons2" src="/static/img/mic-dicons.png" />
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="folder" id="button_add_list">
                        <div class="folder-name-2">새 폴더 추가</div>
                        <div style="padding-top: 80px; padding-right: 10px;">
                            <div class="ellipse-11">
                                <div class="_3-dicons">
                                    <img class="_3-dicons2" src="/static/img/add-dicons.png" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- 모달 content 부분-->
<div id="modal_add_feed_content" class="modal modal_overlay_content">
    <div class="modal_window">
        <div class="modal_title">
            <div class="modal_title_side"></div>
            <div class="modal_title_side">
                <span id="close_modal" class="close_modal material-icons-outlined" style="font-size: 15px">
                    X
                </span>
            </div>
        </div>
        <div class="modal_content_write">
            <div style="height: 150px">
                <textarea id="input_list_name" class="feed_content_textarea form-control col-sm-5" rows="10" placeholder="설명을 입력하세요"></textarea>
            </div>
            <div style="width: 100%; text-align: center">
                <button id="button_write_feed" type="button" class="btn btn-primary" style="width: 268px"> 추가하기</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script>    
    $.ajaxSetup({
        headers: { "X-CSRFToken": '{{csrf_token}}' }
    });
</script>

<script>
    //모달 띄우기 코드
    const modal = document.getElementById("modal_add_feed_content");
    const buttonAddFeed = document.getElementById("button_add_list");
    buttonAddFeed.addEventListener("click", e=> {
        modal.style.top = window.pageYOffset + 'px'; // top을 이용해 시작 y 위치를 바꿔줌
        modal.style.display = "flex";
        document.body.style.overflowY = "hidden"; //스크롤 없애기

        console.log(window.pageYOffset + " 위치"); //로그 찍기
    });

    //모달 닫기 코드
    const buttonCloseModal = 
    document.getElementById("close_modal");
    buttonCloseModal.addEventListener("click", e => {
        modal.style.display = "none";
        document.body.style.overflowY = "visible";
    });

    let listCount = 0; // 추가된 리스트 개수를 추적하기 위한 변수

    

    function addList(fd) {
        $.ajax({
            url: 'add_list/', // 데이터를 전송할 URL
            type: 'POST', // POST 메서드 사용
            data: fd, // FormData를 전송 데이터로 사용
            processData: false, // FormData를 문자열로 변환하지 않음
            contentType: false, // 컨텐츠 유형을 설정하지 않음
            headers:{
                'X-CSRFToken':csrftoken
            },
            success: function(response) {
                // 성공적으로 응답을 받았을 때 실행할 코드
                console.log(response);

                // 새로운 리스트를 추가하는 코드
                const newList = `
                    <div style="background-color: aliceblue; width: 150px; margin: 10px; height: 150px; display: flex; justify-content: center; align-items: center;">
                        <span>${list_name}</span>
                    </div>
                `;

                $('#list_container').append(newList);
                listCount++;

                // 추가 버튼을 오른쪽으로 이동하는 코드
                const buttonWidth = 170; // 추가 버튼을 감싸는 <div> 요소의 너비 + 마진값
                const containerWidth = 700; // 리스트 컨테이너의 너비
                const maxButtonsPerRow = Math.floor(containerWidth / buttonWidth);

                if (listCount % maxButtonsPerRow === 0) {
                    $('#button_add_list').css('float', 'left');
                }

                //location.reload(); // 페이지 새로고침 추가
            },
            error: function(xhr, errmsg, err) {
                // 요청이 실패했을 때 실행할 코드
                console.log(xhr.status + ": " + xhr.responseText);
                var errorMessage = "로그인이 필요합니다.";
                alert(errorMessage);
            }
        });
    }

    $('#button_write_feed').on('click', () => {
        const list_name = $('#input_list_name').val();

        let fd = new FormData();

        fd.append('list_name', list_name); 

        addList(fd); // 리스트 추가 함수 호출

        // 추가 버튼 클릭 후 모달 닫기
        modal.style.display = "none";
        document.body.style.overflowY = "visible";

        setTimeout(() => {
            location.reload();
        }, 100);
    });

    // 모든 리스트 버튼에 대해 클릭 이벤트 리스너를 등록
    const listButtons = document.querySelectorAll(".list_button");
    listButtons.forEach((listButton) => {
        listButton.addEventListener('click', () => {
            const listNumber = listButton.dataset.listNumber;
            const url = `/mylist/${listNumber}/`; // 이동할 URL 설정
            window.location.href = url; // URL로 이동
        });
    });

    
</script>
{% endblock %}